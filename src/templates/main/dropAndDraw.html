<!DOCTYPE html>
<html>
<head>
    <title>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .canvas-container {
            margin: 20px 0;
            border: 3px solid #ddd;
            border-radius: 10px;
            background: white;
            overflow: auto;
            max-height: 500px;
        }
        canvas {
            display: block;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        button {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .save-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .save-buttons button {
            flex: 1;
        }
        #save-png {
            background: #2ecc71;
        }
        #save-json {
            background: #9b59b6;
        }
        #load-json {
            background: #e67e22;
        }
        .danger {
            background: #e74c3c !important;
        }
        .danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        .info-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        .status {
            margin-top: 15px;
            padding: 12px;
            background: #2c3e50;
            color: white;
            border-radius: 8px;
            font-size: 14px;
        }
        .server-section {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #b3dcff;
        }
        .server-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .server-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .server-input button {
            background: #1abc9c;
        }
        .object-count {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        input[type="file"] {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 12px 15px;
            background: #e67e22;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            flex: 1;
            transition: all 0.3s;
        }
        .file-label:hover {
            background: #d35400;
            transform: translateY(-2px);
        }
        .connection-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 13px;
            color: #7f8c8d;
        }
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
            .save-buttons {
                flex-direction: column;
            }
            .server-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>üîó</span>
            –°—Ö–µ–º–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º PNG –∏ JSON
        </h1>
        
        <div class="info-panel">
            <strong>üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –æ–±—ä–µ–∫—Ç—ã –º—ã—à–∫–æ–π</li>
                <li>–í—ã–¥–µ–ª–∏—Ç–µ 2 –æ–±—ä–µ–∫—Ç–∞ ‚Üí "–°–æ–µ–¥–∏–Ω–∏—Ç—å"</li>
                <li>"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG" - —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</li>
                <li>"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON" - —Å–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã</li>
                <li>"–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON" - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –∏–∑ —Ñ–∞–π–ª–∞</li>
                <li>–£–∫–∞–∂–∏—Ç–µ URL —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö</li>
            </ul>
        </div>
        
        <div class="canvas-container"
        data-id="{{schema.id}}"
        data-title="{{schema.title}}"
        >
            <canvas id="canvas" width="900" height="450"></canvas>
        </div>
        
        <div class="object-count">
            <span>–û–±—ä–µ–∫—Ç–æ–≤: <span id="obj-count">2</span></span>
            <span>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–π: <span id="conn-count">0</span></span>
        </div>
        
        <div class="controls">
            {% for comp in components %}
                
                <button
                class="component"
                data-id="{{comp.id}}"
                data-title="{{comp.title}}"
                data-ico="{{comp.ico}}"
                >
                    <img src="comp.ico"/>
                </button>
            {% endfor %}
            <button id="connect-btn" onclick="connectSelected()">
                <span>üîó</span> –°–æ–µ–¥–∏–Ω–∏—Ç—å
            </button>
            <button onclick="clearSelection()">
                <span>‚úñÔ∏è</span> –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            </button>
            <button class="danger" onclick="clearAll()">
                <span>üóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
            </button>
        </div>
        
        <div class="save-buttons">
            <button id="save-png" onclick="saveAsPNG()">
                <span>üñºÔ∏è</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG
            </button>
            <button id="save-json" onclick="saveAsJSON()">
                <span>üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON
            </button>
            <label class="file-label">
                <span>üìÇ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON
                <button id="json-file" accept=".json" onclick="loadFromJSONFile()"></button>
            </label>
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <button id="load-json" onclick="document.getElementById('json-file').click()">
                <span>üìÅ</span> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
            </button>
        </div>
        
        <div class="server-section">
            <h3 style="margin-top: 0; color: #2c3e50;">üåê –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</h3>
            <div class="server-input">
                <input type="text" id="server-url" 
                       placeholder="https://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä.com/api/save" 
                       value="http://localhost:8000/api/save">
                <button onclick="sendToServer()">
                    <span>üì§</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å JSON
                </button>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                <small>–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ</small>
            </div>
        </div>
        
        <div class="connection-stats">
            <span>ID —Å—Ö–µ–º—ã: <span id="schema-id">-</span></span>
            <span>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: <span id="last-save">-</span></span>
        </div>
        
        <div class="status">
            <strong>–°—Ç–∞—Ç—É—Å:</strong> 
            <span id="status">–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <input type="file" id="load-file" accept=".json" style="display: none">
    
    <script>
        // ===== –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
        const canvas = new fabric.Canvas('canvas');
        let connections = [];
        let schemaId = 'schema_' + Date.now();
        let lastSaveTime = null;
        
        
        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
        document.addEventListener('DOMContentLoaded', function() {
            // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
            updateStats();
            updateStatus('–ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –æ–±—ä–µ–∫—Ç—ã –∏ —Å–æ–µ–¥–∏–Ω—è–π—Ç–µ –∏—Ö');
            let comp_btn = document.querySelectorAll('.component');
            
            comp_btn.forEach(function (btn){
                btn.addEventListener("click", function(){
                    data_id = this.getAttribute("data-id");
                    data_title = this.getAttribute("data-title");
                    data_ico = this.getAttribute("data-ico");
                    addComponent(data_id, data_ico, data_title);
                });
            });
            
            
            // –û–±–Ω–æ–≤–ª—è–µ–º ID —Å—Ö–µ–º—ã
            document.getElementById('schema-id').textContent = schemaId;
        });
        

        
        // ===== –î–û–ë–ê–í–õ–ï–ù–ò–ï –û–ë–™–ï–ö–¢–û–í =====
        function addComponent(id, ico, title) {
            // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            fabric.Image.fromURL(ico, function(img) {
                const uniqueId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                img.set({
                    left: 50 + Math.random() * 600,
                    top: 50 + Math.random() * 300,
                    width: 60,
                    height: 60,
                    scaleX: 60 / img.width,  // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                    scaleY: 60 / img.height,
                    rx: 5,  // –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤
                    ry: 5,
                    id: id, 
                    title: title,
                    ico: ico,
                    uniqueId: uniqueId
                });
                
                canvas.add(img);
                updateStats();
               
            });
        }
        
        
       
        

        
        // ===== –°–û–ï–î–ò–ù–ï–ù–ò–ï –û–ë–™–ï–ö–¢–û–í =====
        function connectObjects(obj1, obj2) {
            const center1 = getObjectCenter(obj1);
            const center2 = getObjectCenter(obj2);
            
            const line = new fabric.Line([
                center1.x, center1.y,
                center2.x, center2.y
            ], {
                stroke: '#2C3E50',
                strokeWidth: 3,
                fill: '',
                selectable: true,
                evented: true,
                hasControls: false,
                hasBorders: false,
                connectedObjects: [obj1, obj2],
                id: 'conn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
            });
            
            addArrow(line, center1, center2);
            
            canvas.add(line);
            canvas.sendToBack(line);
            
            connections.push({
                line: line,
                obj1: obj1,
                obj2: obj2
            });
            
            updateStats();
            return line;
        }
        
        function getObjectCenter(obj) {
            if (obj.type === 'circle') {
                return {
                    x: obj.left + obj.radius,
                    y: obj.top + obj.radius
                };
            } else if (obj.type === 'triangle') {
                return {
                    x: obj.left + obj.width / 2,
                    y: obj.top + obj.height / 2
                };
            } else if (obj.type === 'textbox') {
                return {
                    x: obj.left + obj.width / 2,
                    y: obj.top + obj.height / 2
                };
            } else {
                return {
                    x: obj.left + obj.width / 2,
                    y: obj.top + obj.height / 2
                };
            }
        }
        
        function addArrow(line, from, to) {
            const angle = Math.atan2(to.y - from.y, to.x - from.x);
            const arrowSize = 10;
            
            const arrow = new fabric.Path(
                `M ${to.x} ${to.y} 
                 L ${to.x - arrowSize * Math.cos(angle - Math.PI/6)} ${to.y - arrowSize * Math.sin(angle - Math.PI/6)} 
                 L ${to.x - arrowSize * Math.cos(angle + Math.PI/6)} ${to.y - arrowSize * Math.sin(angle + Math.PI/6)} 
                 Z`, 
                {
                    fill: line.stroke,
                    stroke: line.stroke,
                    strokeWidth: 1,
                    selectable: false,
                    evented: false,
                    id: 'arrow_' + line.id
                }
            );
            
            canvas.add(arrow);
            line.arrow = arrow;
        }
        
        // ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –õ–ò–ù–ò–ô =====
        canvas.on('object:moving', function(e) {
            const movingObj = e.target;
            
            connections.forEach(conn => {
                if (conn.obj1 === movingObj || conn.obj2 === movingObj) {
                    updateConnection(conn.line, conn.obj1, conn.obj2);
                }
            });
        });
        
        function updateConnection(line, obj1, obj2) {
            const center1 = getObjectCenter(obj1);
            const center2 = getObjectCenter(obj2);
            
            line.set({
                x1: center1.x,
                y1: center1.y,
                x2: center2.x,
                y2: center2.y
            });
            
            if (line.arrow) {
                canvas.remove(line.arrow);
                addArrow(line, center1, center2);
            }
            
            canvas.renderAll();
        }
        
        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï =====
        function connectSelected() {
            const activeObjects = canvas.getActiveObjects();
            
            if (activeObjects.length === 2) {
                const objects = activeObjects.filter(obj => 
                    obj.type !== 'line' && obj.type !== 'path'
                );
                
                if (objects.length === 2) {
                    connectObjects(objects[0], objects[1]);
                    canvas.discardActiveObject();
                    updateStatus('–û–±—ä–µ–∫—Ç—ã —Å–æ–µ–¥–∏–Ω–µ–Ω—ã');
                } else {
                    updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ –æ–±—ä–µ–∫—Ç–∞ (–Ω–µ –ª–∏–Ω–∏–∏)');
                }
            } else {
                updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }
        
        function clearSelection() {
            canvas.discardActiveObject();
            canvas.renderAll();
            updateStatus('–í—ã–¥–µ–ª–µ–Ω–∏–µ —Å–Ω—è—Ç–æ');
        }
        
        function clearAll() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è?')) {
                canvas.clear();
                connections = [];
                updateStats();
                updateStatus('–í—Å–µ –æ–±—ä–µ–∫—Ç—ã —É–¥–∞–ª–µ–Ω—ã');
            }
        }
        
        // ===== –°–û–•–†–ê–ù–ï–ù–ò–ï PNG =====
        function saveAsPNG() {
            const link = document.createElement('a');
            link.download = `schema_${schemaId}_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 2
            });
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateLastSave();
            updateStatus('–°—Ö–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ PNG');
        }
        
        // ===== –°–û–•–†–ê–ù–ï–ù–ò–ï JSON =====
        function saveAsJSON() {
            const schemaData = collectSchemaData();
            const jsonStr = JSON.stringify(schemaData, null, 2);
            
            const link = document.createElement('a');
            link.download = `schema_${schemaId}.json`;
            link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(jsonStr);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateLastSave();
            updateStatus('–î–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–∞–∫ JSON');
        }
        
        function collectSchemaData() {
            const objects = canvas.getObjects().filter(obj => 
                obj.type !== 'line' && obj.type !== 'path' && !obj.id?.startsWith('arrow_')
            );
            
            const lines = canvas.getObjects().filter(obj => 
                obj.type === 'line'
            );
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            return {
                metadata: {
                    schemaId: schemaId,
                    createdAt: new Date().toISOString(),
                    name: `–°—Ö–µ–º–∞ ${schemaId}`,
                    version: '1.0',
                    fabricVersion: fabric.version
                },
                canvas: {
                    width: canvas.width,
                    height: canvas.height,
                    backgroundColor: canvas.backgroundColor
                },
                objects: objects.map(obj => ({
                    id: obj.id || `obj_${Date.now()}_${Math.random()}`,
                    type: obj.type,
                    left: obj.left,
                    top: obj.top,
                    width: obj.width || obj.radius * 2 || 0,
                    height: obj.height || obj.radius * 2 || 0,
                    radius: obj.radius,
                    fill: obj.fill,
                    stroke: obj.stroke,
                    strokeWidth: obj.strokeWidth,
                    angle: obj.angle,
                    scaleX: obj.scaleX,
                    scaleY: obj.scaleY,
                    text: obj.text,
                    fontSize: obj.fontSize,
                    fontFamily: obj.fontFamily,
                    rx: obj.rx,
                    ry: obj.ry,
                    id: obj.id, 
                    title: obj.title,
                    ico: obj.ico



                })),
                connections: lines.map(line => {
                    const conn = connections.find(c => c.line === line);
                    return {
                        id: line.id || `conn_${Date.now()}_${Math.random()}`,
                        fromObjectId: conn?.obj1?.id,
                        toObjectId: conn?.obj2?.id,
                        stroke: line.stroke,
                        strokeWidth: line.strokeWidth,
                        points: [line.x1, line.y1, line.x2, line.y2]
                    };
                }).filter(conn => conn.fromObjectId && conn.toObjectId),
                stats: {
                    totalObjects: objects.length,
                    totalConnections: lines.length,
                    lastModified: new Date().toISOString()
                }
            };
        }
        
        // ===== –ó–ê–ì–†–£–ó–ö–ê –ò–ó JSON ====================================================================================================================

















        //=======================================================================================================================================================
        async function loadFromJSONFile() {
            const schema_id = 1;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                // 1. –ò—Å–ø–æ–ª—å–∑—É–µ–º POST –º–µ—Ç–æ–¥, –∞ –Ω–µ GET
                const response = await fetch('/get_schema', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken, 
                    },
                    body: JSON.stringify({ 
                        'schema_id': schema_id
                    })
                });
                
                // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // 3. –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
                const data = await response.json();
                
                // 4. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ö–µ–º—É
                loadSchema(data);
                updateStatus('–°—Ö–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞');
                
            } catch (error) {
                console.error("[Error]", error);
                updateStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ö–µ–º—ã: ' + error.message);
            }
        }
        
        function loadSchema(data) {
            // –û—á–∏—â–∞–µ–º canvas
            canvas.clear();
            connections = [];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            if (data.metadata?.schemaId) {
                schemaId = data.metadata.schemaId;
                document.getElementById('schema-id').textContent = schemaId;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã
            const objectMap = new Map();
            
            if (data.objects) {
                data.objects.forEach(objData => {
                    let fabricObj;
                    
                    fabricObj = fabric.Image.fromURL(objData.ico, function(img) {
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
                        img.set({
                            left: objData.left,
                            top: objData.top,
                            width: objData.width,
                            height: objData.height,
                            scaleX: objData.scaleX,  // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                            scaleY: objData.scaleY,
                            rx: objData.rx,  // –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤
                            ry: objData.ry,
                            id: objData.id, 
                            title: objData.title,
                            ico: objData.ico
                        });
                        
                        canvas.add(img);
                        updateStats();
                    
                    });
                    
                    if (fabricObj) {
                        objectMap.set(objData.id, fabricObj);
                        canvas.add(fabricObj);
                    }
                });
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (data.connections) {
                data.connections.forEach(connData => {
                    const obj1 = objectMap.get(connData.fromObjectId);
                    const obj2 = objectMap.get(connData.toObjectId);
                    
                    if (obj1 && obj2) {
                        const line = connectObjects(obj1, obj2);
                        if (line) {
                            line.set({
                                stroke: connData.stroke || '#2C3E50',
                                strokeWidth: connData.strokeWidth || 3,
                                id: connData.id
                            });
                        }
                    }
                });
            }
            
            updateStats();
            updateLastSave();
            canvas.renderAll();
        }
        
        // ===== –û–¢–ü–†–ê–í–ö–ê –ù–ê –°–ï–†–í–ï–† =====
        async function sendToServer() {
            
        
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const schemaData = collectSchemaData();
            let schema = document.querySelector(".canvas-container");
            let schema_id = schema.getAttribute('data-id');
            let schema_title = schema.getAttribute('data-title');
            try {
                updateStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
                
                const response = await fetch('/save_schema', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        "dump":schemaData,
                        "schema_id": schema_id,
                        "schema_title": schema_title
                        
                    })
                    
                });
                
            
                
            } catch (error) {
                console.error('Error sending to server:', error);
                updateStatus(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`);
            }
        }
        
        // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
        function updateStats() {
            const objects = canvas.getObjects().filter(obj => 
                obj.type !== 'line' && obj.type !== 'path' && !obj.id?.startsWith('arrow_')
            );
            const lines = canvas.getObjects().filter(obj => obj.type === 'line');
            
            document.getElementById('obj-count').textContent = objects.length;
            document.getElementById('conn-count').textContent = lines.length;
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        function updateLastSave() {
            lastSaveTime = new Date();
            const timeStr = lastSaveTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('last-save').textContent = timeStr;
        }
        
        // ===== –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò =====
        document.addEventListener('keydown', function(e) {
            // Delete - —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
            if (e.key === 'Delete') {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ª–∏–Ω–∏—è - —É–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                    if (activeObject.type === 'line') {
                        connections = connections.filter(conn => conn.line !== activeObject);
                        if (activeObject.arrow) {
                            canvas.remove(activeObject.arrow);
                        }
                    }
                    
                    canvas.remove(activeObject);
                    updateStats();
                    updateStatus('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω');
                }
            }
            
            // Ctrl+S - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveAsJSON();
            }
            
            // Ctrl+P - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                saveAsPNG();
            }
        });
        
        // ===== –°–û–ë–´–¢–ò–Ø =====
        canvas.on('selection:created', function(e) {
            const selected = e.selected;
            if (selected.length === 1) {
                updateStatus('–û–±—ä–µ–∫—Ç –≤—ã–±—Ä–∞–Ω. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è');
            } else if (selected.length === 2) {
                updateStatus('–í—ã–±—Ä–∞–Ω–æ 2 –æ–±—ä–µ–∫—Ç–∞. –ù–∞–∂–º–∏—Ç–µ "–°–æ–µ–¥–∏–Ω–∏—Ç—å"');
            }
        });
        
        canvas.on('object:added', updateStats);
        canvas.on('object:removed', updateStats);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤
        canvas.on('object:scaling', function(e) {
            const scaledObj = e.target;
            connections.forEach(conn => {
                if (conn.obj1 === scaledObj || conn.obj2 === scaledObj) {
                    updateConnection(conn.line, conn.obj1, conn.obj2);
                }
            });
        });
    </script>
</body>
</html>